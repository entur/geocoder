name: "[Internal] Build and Push Docker Image"

on:
  workflow_call:
    inputs:
      image_name:
        description: "Docker image name"
        type: string
        required: true
      dockerfile:
        description: "Path to Dockerfile"
        type: string
        default: "Dockerfile"
      build_args:
        description: "Build arguments (KEY=VALUE, one per line)"
        type: string
        required: false
      push:
        description: "Push image to registry"
        type: boolean
        default: false
      run-group:
        description: "The run group to use for the job"
        type: string
        required: false
        default: grp-ubuntu-24.04-2core-x64
    outputs:
      image_tag:
        description: "Image tag (git SHA)"
        value: ${{ jobs.build-push.outputs.image_tag }}

env:
  REGISTRY: eu.gcr.io/entur-system-1287

jobs:
  build-push:
    name: Build and Push
    runs-on:
      group: ${{ inputs.run-group }}
    timeout-minutes: 40
    permissions:
      contents: read
      id-token: write
    outputs:
      image_tag: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate with GCP
        if: ${{ inputs.push }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}

      - name: Configure Docker for GCR
        if: ${{ inputs.push }}
        run: gcloud auth configure-docker eu.gcr.io --quiet

      - name: Build and push to GCR
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ inputs.image_name }}
          push: ${{ inputs.push }}
          tags: |
            ${{ env.REGISTRY }}/${{ inputs.image_name }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ inputs.image_name }}:latest
          build-args: ${{ inputs.build_args }}
          provenance: false
