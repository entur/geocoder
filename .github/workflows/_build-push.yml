name: "[Internal] Build and Push Docker Image"

on:
  workflow_call:
    inputs:
      image_name:
        description: "Docker image name (defaults to repository name)"
        type: string
        required: false
      dockerfile:
        description: "Path to Dockerfile"
        type: string
        default: "Dockerfile"
      build_args:
        description: "Build arguments (KEY=VALUE, one per line)"
        type: string
        required: false
      context:
        description: "Build context"
        type: string
        default: "."
    outputs:
      image_name:
        description: "Image name"
        value: ${{ jobs.build-push.outputs.image_name }}
      image_tag:
        description: "Image tag (git SHA)"
        value: ${{ jobs.build-push.outputs.image_tag }}

env:
  REGISTRY: eu.gcr.io/entur-system-1287
  IMAGE_NAME: ${{ inputs.image_name }}
  DOCKERFILE: ${{ inputs.dockerfile }}

jobs:
  build-push:
    name: Build and Push
    runs-on:
      group: grp-ubuntu-24.04-4core-x64
    timeout-minutes: 40
    permissions:
      contents: read
      id-token: write
    outputs:
      image_name: ${{ env.IMAGE_NAME }}
      image_tag: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3.11.1

      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker eu.gcr.io --quiet

      - name: Build and push to GCR
        uses: docker/build-push-action@v6.18.0
        with:
          context: ${{ inputs.context }}
          file: ${{ env.DOCKERFILE }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          build-args: ${{ inputs.build_args }}
          provenance: false
