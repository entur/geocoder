name: "[Internal] Build and Push Docker Image"

on:
  workflow_call:
    inputs:
      image_name:
        description: "Docker image name"
        type: string
        required: true
      context:
        description: "Build context"
        type: string
        default: "."
      dockerfile:
        description: "Path to Dockerfile"
        type: string
        default: "Dockerfile"
      build_args:
        description: "Build arguments (KEY=VALUE, one per line)"
        type: string
      push:
        description: "Push image to registry"
        type: boolean
        default: false
      run-group:
        description: "The run group to use for the job"
        type: string
        default: grp-ubuntu-24.04-2core-x64
      do-gradle-build:
        description: "Run Gradle build before building the Docker image"
        type: boolean
        default: false
      artifact_from_image:
        description: "Docker image to extract artifact from (format: image:tag)"
        type: string
        required: false
      artifact_from_image_path:
        description: "Path to file inside the Docker image to extract"
        type: string
        required: false
        default: "/photon_data.tar.xz"
    outputs:
      image_tag:
        description: "Image tag"
        value: ${{ jobs.build-push.outputs.image_tag }}

env:
  REGISTRY: eu.gcr.io/entur-system-1287

jobs:
  build-push:
    name: Build and Push
    runs-on:
      group: ${{ inputs.run-group }}
    timeout-minutes: 40
    permissions:
      contents: read
      id-token: write
    outputs:
      image_tag: ${{ env.image_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 21
        if: ${{ inputs.do-gradle-build }}
        uses: actions/setup-java@v5
        with:
          distribution: liberica
          java-version: 21
          cache: gradle

      - name: Build with Gradle
        if: ${{ inputs.do-gradle-build }}
        run: ./gradlew --no-daemon build

      - name: Download artifact from Docker image
        if: ${{ inputs.artifact_from_image != '' }}
        uses: ./.github/actions/download-docker-artifact
        with:
          image: ${{ inputs.artifact_from_image }}
          artifact_path: ${{ inputs.artifact_from_image_path }}
          destination: ${{ inputs.context }}
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate with GCP
        if: ${{ inputs.push }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}

      - name: Configure Docker for GCR
        if: ${{ inputs.push }}
        run: |
          REGISTRY_DOMAIN=$(echo "${REGISTRY}" | cut -d'/' -f1)
          gcloud auth configure-docker ${REGISTRY_DOMAIN} --quiet

      - name: Set image tag variable
        id: set-image-tag
        shell: bash
        run: |
          branch=$(echo "${GITHUB_REF_NAME:-detached}" | sed 's/[^a-zA-Z0-9_-]\+/_/g')
          echo "image_tag=${branch}.$(date +'%Y%m%d')-SHA${GITHUB_SHA:0:7}" > $GITHUB_ENV

      - name: Build and push to GCR
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.context }}/${{ inputs.dockerfile }}
          push: ${{ inputs.push }}
          tags: |
            ${{ env.REGISTRY }}/${{ inputs.image_name }}:${{ env.image_tag }}
            ${{ env.REGISTRY }}/${{ inputs.image_name }}:latest
          build-args: ${{ inputs.build_args }}
          provenance: false

      - name: Write build and push summary
        if: always()
        run: |
          echo "## Docker Build & Push Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.REGISTRY }}/${{ inputs.image_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ env.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build args:** \`${{ inputs.build_args != '' && inputs.build_args || 'None' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**SHA:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Full reference:** \`${{ env.REGISTRY }}/${{ inputs.image_name }}:${{ env.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Push requested:** ${{ inputs.push }}" >> $GITHUB_STEP_SUMMARY
          echo "**Job status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY