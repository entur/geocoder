name: "[Internal] Build and Push Docker Image"

on:
  workflow_call:
    inputs:
      image_name:
        description: "Docker image name"
        type: string
        required: true
      context:
        description: "Build context"
        type: string
        default: "."
      dockerfile:
        description: "Path to Dockerfile"
        type: string
        default: "Dockerfile"
      build_args:
        description: "Build arguments (KEY=VALUE, one per line)"
        type: string
      push:
        description: "Push image to registry"
        type: boolean
        default: false
      do-gradle-build:
        description: "Run Gradle build before building the Docker image"
        type: boolean
        default: false
      docker_artifact_image:
        description: "Docker image to extract artifact from (format: image:tag)"
        type: string
        required: false
    outputs:
      image_tag:
        description: "Image tag"
        value: ${{ jobs.build-push.outputs.image_tag }}

env:
  REGISTRY: eu.gcr.io/entur-system-1287

jobs:
  build-push:
    name: Build and Push
    runs-on: ubuntu-latest
    timeout-minutes: 40
    permissions:
      contents: read
      id-token: write
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 21
        if: ${{ inputs.do-gradle-build }}
        uses: actions/setup-java@v5
        with:
          distribution: liberica
          java-version: 21
          cache: gradle

      - name: Build with Gradle
        if: ${{ inputs.do-gradle-build }}
        run: ./gradlew --no-daemon build

      - name: Download artifact from Docker image
        if: ${{ inputs.docker_artifact_image != '' }}
        uses: ./.github/actions/download-docker-artifact
        with:
          image: ${{ inputs.docker_artifact_image }}
          destination: ${{ inputs.context }}
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate with GCP
        if: ${{ inputs.push }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}

      - name: Configure Docker for GCR
        if: ${{ inputs.push }}
        run: |
          REGISTRY_DOMAIN=$(echo "${REGISTRY}" | cut -d'/' -f1)
          gcloud auth configure-docker ${REGISTRY_DOMAIN} --quiet

      - name: Generate image tag
        id: set-tag
        uses: ./.github/actions/generate-image-tag
        with:
          image_name: ${{ inputs.image_name }}

      - name: Build and push to GCR
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.context }}
          file: ${{ inputs.context }}/${{ inputs.dockerfile }}
          push: ${{ inputs.push }}
          tags: |
            ${{ steps.set-tag.outputs.full_image }}
            ${{ steps.set-tag.outputs.base_image }}:latest
          build-args: ${{ inputs.build_args }}
          provenance: false

      - name: Write build and push summary
        if: always()
        run: |
          echo "## Docker Build & Push Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ steps.set-tag.outputs.full_image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Build args:** \`${{ inputs.build_args != '' && inputs.build_args || 'None' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Push requested:** ${{ inputs.push }}" >> $GITHUB_STEP_SUMMARY
