name: "[Internal] Docker Security Scan"

on:
  workflow_call:
    inputs:
      image_name:
        description: "Full image name with tag (e.g., eu.gcr.io/repo/image:tag)"
        type: string
        required: true

jobs:
  docker-scan:
    name: Security Scan
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    permissions:
      actions: read
      contents: read
      id-token: write
      security-events: write
      pull-requests: write

    steps:
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker eu.gcr.io --quiet

      - name: Pull image from GCR
        run: docker pull ${{ inputs.image_name }}

      - name: Scan for vulnerabilities
        uses: anchore/scan-action@v7
        id: scan
        with:
          image: ${{ inputs.image_name }}
          by-cve: true
          fail-build: false
          severity-cutoff: critical

      - name: Upload vulnerability report to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
          category: 'grype-scan'


