name: "[Internal] Docker Security Scan"

on:
  workflow_call:
    inputs:
      image:
        description: "Image name with tag (e.g. image:tag)"
        type: string
        required: true

env:
  REGISTRY: eu.gcr.io/entur-system-1287

jobs:
  docker-scan:
    name: Security Scan
    runs-on: ubuntu-24.04
    timeout-minutes: 20
    permissions:
      actions: read
      contents: read
      id-token: write
      security-events: write
      pull-requests: write

    steps:
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}

      - name: Configure Docker for GCR
        run: gcloud auth configure-docker eu.gcr.io --quiet

      - name: Pull image from GCR
        run: docker pull ${{ env.REGISTRY }}/${{ inputs.image }}

      - name: Scan for vulnerabilities
        uses: anchore/scan-action@v7
        id: scan
        with:
          image: ${{ env.REGISTRY }}/${{ inputs.image }}
          by-cve: true
          fail-build: false
          severity-cutoff: critical

      - name: Upload vulnerability report to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
          category: 'grype-scan'

      - name: Write scan summary
        if: always()
        run: |
          echo "## Docker Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** ${{ env.REGISTRY }}/${{ inputs.image }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Status:** ${{ steps.scan.outcome }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.scan.outputs.success }}" = "false" ]; then
            echo "**⚠️ Critical vulnerabilities detected!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**✅ No critical vulnerabilities found.**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View full report in the [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)." >> $GITHUB_STEP_SUMMARY
