name: Photon - Import data and/or deploy

on:
  workflow_dispatch:
    inputs:
      build_import:
        description: 'Build import image?'
        required: true
        type: boolean
        default: false
      deploy_env:
        description: 'Deploy Photon to (none = no deployment)'
        required: true
        type: choice
        options:
          - none
          - dev
          - tst
          - both
        default: 'none'
      import_image_tag:
        description: 'Import image tag or digest (avoid "latest")'
        required: false
        default: 'latest'
        type: string

run-name: "Photon: import=${{ inputs.build_import }}, deploy=${{ inputs.deploy_env }} (sha: ${{ github.sha }})"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.compute.outputs.tag }}
    steps:
      - name: Compute custom tag
        id: compute
        shell: bash
        run: |
          ref="${{ github.ref }}"
          if [[ "$ref" == refs/heads/* ]]; then
            branch="${ref#refs/heads/}"
          else
            branch="unknown"
          fi
          date=$(date -u +%Y%m%d)
          short_sha="${GITHUB_SHA:0:8}"
          tag="${branch}.${date}-SHA${short_sha}"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

  import:
    runs-on: ubuntu-latest
    needs: tag
    if: ${{ inputs.build_import == true }}
    permissions:
      contents: read
      id-token: write
      security-events: write
      actions: read
    outputs:
      image_tag: ${{ steps.build_push.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: 'liberica'
          java-version: '21'
          cache: 'gradle'
      - name: Build converter JAR
        run: ./gradlew --no-daemon :converter:build
      - name: Build and push import image
        id: build_push
        uses: ./.github/actions/build-push
        with:
          image_name: geocoder-import
          dockerfile: Dockerfile.import
          push: true
          image_tag: ${{ needs.tag.outputs.tag }}
          run-group: 'grp-ubuntu-24.04-8core-x64'
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}

  photon:
    runs-on: ubuntu-latest
    needs: [tag, import]
    if: ${{ inputs.deploy_env != 'none' }}
    permissions:
      contents: read
      id-token: write
      security-events: write
      actions: read
    outputs:
      name_with_tag: ${{ steps.build_push.outputs.name_with_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Authenticate with GCP (for image resolution)
        if: ${{ inputs.build_import == false }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}

      - name: Resolve import image reference
        id: resolve_import
        shell: bash
        run: |
          if [[ "${{ inputs.build_import }}" == "true" ]]; then
            # Use the custom tag
            ref="${{ needs.import.outputs.image_tag }}"
          else
            user_tag="${{ inputs.import_image_tag }}"
            if [[ "$user_tag" == sha256:* ]]; then
              ref="$user_tag"
            else
              # Resolve tag to digest to ensure immutability
              full_image="eu.gcr.io/entur-system-1287/geocoder-import:$user_tag"
              digest=$(gcloud container images describe --format='value(image_summary.digest)' "$full_image")
              if [[ -z "$digest" ]]; then
                echo "ERROR: Could not resolve $full_image" >&2
                exit 1
              fi
              ref="$digest"
            fi
          fi
          echo "import_ref=$ref" >> "$GITHUB_OUTPUT"

      - name: Build and push photon image
        id: build_push
        uses: ./.github/actions/build-push
        with:
          image_name: geocoder-photon
          dockerfile: Dockerfile.photon
          push: true
          image_tag: ${{ needs.tag.outputs.tag }}
          build_args: |
            IMPORT_IMAGE=eu.gcr.io/entur-system-1287/geocoder-import@${{ steps.resolve_import.outputs.import_ref }}
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}

  dev-deploy:
    if: |
      github.ref == 'refs/heads/main' &&
      !cancelled() &&
      (inputs.deploy_env == 'dev' || inputs.deploy_env == 'both')
    needs: photon
    uses: entur/gha-helm/.github/workflows/deploy.yml@v1
    with:
      environment: dev
      image: ${{ needs.photon.outputs.name_with_tag }}  # e.g., geocoder-photon:main.20251028-SHAbe4d8ca
      chart: helm/geocoder-photon
      namespace: geocoder
      release_name: geocoder-photon
    secrets: inherit

  tst-deploy:
    if: |
      github.ref == 'refs/heads/main' &&
      !cancelled() &&
      (inputs.deploy_env == 'tst' || inputs.deploy_env == 'both')
    needs: photon
    uses: entur/gha-helm/.github/workflows/deploy.yml@v1
    with:
      environment: tst
      image: ${{ needs.photon.outputs.name_with_tag }}
      chart: helm/geocoder-photon
      namespace: geocoder
      release_name: geocoder-photon
    secrets: inherit