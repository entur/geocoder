name: Photon - Import data and/or deploy

on:
  workflow_dispatch:
    inputs:
      build_import:
        description: 'Build import image?'
        required: true
        type: boolean
        default: false
      deploy_env:
        description: 'Deploy Photon to (none = no deployment)'
        required: true
        type: choice
        options:
          - none
          - dev
          - tst
          - both
        default: 'none'
      import_image_tag:
        description: 'Import image tag to use for photon build (if not building import)'
        required: false
        default: 'latest'
        type: string

run-name: "Photon: import=${{ inputs.build_import }}, deploy=${{ inputs.deploy_env }} (sha: ${{ github.sha }})"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:

  import:
    runs-on: ubuntu-latest
    # Always runs so 'photon' can safely depend on it
    permissions:
      contents: read
      id-token: write
      security-events: write
      actions: read

    outputs:
      image_tag: ${{ steps.set_output.outputs.image_tag }}

    steps:
      - name: Checkout and build import (if needed)
        if: ${{ inputs.build_import == true }}
        run: |
          echo "Building import image..."
          # We'll do real steps below

      - name: Checkout code
        if: ${{ inputs.build_import == true }}
        uses: actions/checkout@v5

      - name: Set up JDK 21
        if: ${{ inputs.build_import == true }}
        uses: actions/setup-java@v5
        with:
          distribution: 'liberica'
          java-version: '21'
          cache: 'gradle'

      - name: Build converter JAR
        if: ${{ inputs.build_import == true }}
        run: ./gradlew --no-daemon :converter:build

      - name: Build and push import image
        id: build_push
        if: ${{ inputs.build_import == true }}
        uses: ./.github/actions/build-push
        with:
          image_name: geocoder-import
          dockerfile: Dockerfile.import
          push: true
          run-group: 'grp-ubuntu-24.04-8core-x64'
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}

      - name: Output import tag (when built)
        id: set_output
        if: ${{ inputs.build_import == true }}
        shell: bash
        run: |
          echo "image_tag=${{ steps.build_push.outputs.image_tag }}" >> "$GITHUB_OUTPUT"

      - name: Output placeholder (when not built)
        if: ${{ inputs.build_import == false }}
        shell: bash
        run: |
          # Output is unused, but job must produce the output key
          echo "image_tag=" >> "$GITHUB_OUTPUT"

  photon:
    runs-on: ubuntu-latest
    needs: import
    if: ${{ inputs.deploy_env != 'none' }}

    permissions:
      contents: read
      id-token: write
      security-events: write
      actions: read

    outputs:
      name_with_tag: ${{ steps.build_push.outputs.name_with_tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Resolve import image tag
        id: resolve_tag
        shell: bash
        run: |
          if [[ "${{ inputs.build_import }}" == "true" ]]; then
            tag="${{ needs.import.outputs.image_tag }}"
          else
            tag="${{ inputs.import_image_tag }}"
          fi
          echo "Using import image tag: $tag"
          echo "IMPORT_TAG=$tag" >> "$GITHUB_ENV"

      - name: Build and push photon image
        id: build_push
        uses: ./.github/actions/build-push
        with:
          image_name: geocoder-photon
          dockerfile: Dockerfile.photon
          push: true
          build_args: |
            IMPORT_IMAGE=eu.gcr.io/entur-system-1287/geocoder-import:${{ env.IMPORT_TAG }}
          service_account: ${{ vars.CI_SERVICE_ACCOUNT }}
          workload_identity_provider: ${{ vars.CI_WORKLOAD_IDENTITY_PROVIDER }}

  dev-deploy:
    if: |
      github.ref == 'refs/heads/main' &&
      !cancelled() &&
      (inputs.deploy_env == 'dev' || inputs.deploy_env == 'both')
    needs: photon
    uses: entur/gha-helm/.github/workflows/deploy.yml@v1
    with:
      environment: dev
      image: ${{ needs.photon.outputs.name_with_tag }}
      chart: helm/geocoder-photon
      namespace: geocoder
      release_name: geocoder-photon
    secrets: inherit

  tst-deploy:
    if: |
      github.ref == 'refs/heads/main' &&
      !cancelled() &&
      (inputs.deploy_env == 'tst' || inputs.deploy_env == 'both')
    needs: photon
    uses: entur/gha-helm/.github/workflows/deploy.yml@v1
    with:
      environment: tst
      image: ${{ needs.photon.outputs.name_with_tag }}
      chart: helm/geocoder-photon
      namespace: geocoder
      release_name: geocoder-photon
    secrets: inherit